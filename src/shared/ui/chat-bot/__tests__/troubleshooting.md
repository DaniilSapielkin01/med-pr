# Troubleshooting ChatBot - Решение проблем

## Возможные ошибки при первом отправке сообщения

### 1. Ошибка: "Failed to fetch" или Network Error

**Причина**: 
- API endpoint `/api/chat` не найден или не доступен
- Проблема с CORS
- Проблема с маршрутизацией Next.js

**Решение**:
1. Проверьте, что файл API route находится в правильном месте:
   - Для Next.js App Router: `app/api/chat/route.ts`
   - Текущее расположение: `src/api/chat/chat.ts` - **НЕПРАВИЛЬНО!**

2. Переместите файл в правильное место:
   ```bash
   mkdir -p app/api/chat
   mv src/api/chat/chat.ts app/api/chat/route.ts
   ```

3. Обновите импорты если нужно

4. Проверьте, что сервер запущен: `npm run dev`

### 2. Ошибка: "Немає API_KEY"

**Причина**: 
- Отсутствует переменная окружения `NEXT_PUBLIC_AI_API_KEY`

**Решение**:
1. Создайте файл `.env.local` в корне проекта:
   ```
   NEXT_PUBLIC_AI_API_KEY=your_api_key_here
   NEXT_PUBLIC_MAIN_PAGE=https://prevention.in.ua
   ```

2. Перезапустите сервер после добавления переменных

### 3. Ошибка: "Порожнє повідомлення"

**Причина**: 
- API получает пустое сообщение или только пробелы

**Решение**:
- Компонент уже валидирует пустые сообщения на клиенте
- Проверьте, что `inputValue.trim()` не пустой перед отправкой

### 4. Ошибка: "Помилка API" (статус 500)

**Причина**: 
- Проблема с OpenRouter API
- Неверный API ключ
- Превышен лимит запросов

**Решение**:
1. Проверьте API ключ в `.env.local`
2. Проверьте баланс на OpenRouter
3. Проверьте логи сервера для деталей ошибки

### 5. Ошибка: "Не вдалося прочитати sitemap-rag.json"

**Причина**: 
- Файл `public/sitemap-rag.json` отсутствует или поврежден

**Решение**:
1. Проверьте наличие файла: `public/sitemap-rag.json`
2. Проверьте валидность JSON:
   ```bash
   cat public/sitemap-rag.json | python3 -m json.tool
   ```
3. Если файл отсутствует, создайте его или используйте fallback

### 6. Ошибка: Ответ не отображается

**Причина**: 
- Неверный формат ответа от API
- Проблема с парсингом JSON

**Решение**:
1. Проверьте формат ответа API:
   ```json
   { "answer": "текст ответа" }
   ```

2. Проверьте, что API возвращает правильный Content-Type:
   ```typescript
   return NextResponse.json({ answer: "..." });
   ```

### 7. Ошибка: CORS при разработке

**Причина**: 
- Проблемы с CORS при локальной разработке

**Решение**:
- Next.js API routes не должны иметь проблем с CORS
- Если используете внешний API, добавьте CORS headers:
  ```typescript
  headers: {
    "Access-Control-Allow-Origin": "*",
    "Access-Control-Allow-Methods": "POST",
  }
  ```

### 8. Ошибка: Компонент не рендерится

**Причина**: 
- Проблемы с импортами
- Проблемы с CSS модулями

**Решение**:
1. Проверьте импорты:
   ```typescript
   import { ChatBot } from "@/shared/ui";
   ```

2. Проверьте, что компонент экспортирован в `src/shared/ui/index.ts`

3. Проверьте консоль браузера на ошибки

### 9. Ошибка: Анимации не работают

**Причина**: 
- Проблемы с framer-motion
- SSR проблемы

**Решение**:
- Компонент уже помечен как `"use client"`
- Проверьте, что framer-motion установлен: `npm list framer-motion`

### 10. Ошибка: Стили не применяются

**Причина**: 
- Проблемы с vanilla-extract
- CSS не загружается

**Решение**:
1. Проверьте конфигурацию Next.js для vanilla-extract
2. Проверьте, что стили импортируются корректно
3. Перезапустите dev server

## Диагностика проблем

### Шаг 1: Проверка консоли браузера
Откройте DevTools (F12) и проверьте:
- Ошибки в Console
- Ошибки в Network tab при отправке сообщения

### Шаг 2: Проверка логов сервера
Проверьте терминал где запущен `npm run dev`:
- Ошибки при чтении sitemap-rag.json
- Ошибки API запросов
- Ошибки OpenRouter

### Шаг 3: Проверка API endpoint
Проверьте напрямую:
```bash
curl -X POST http://localhost:3000/api/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "тест"}'
```

### Шаг 4: Проверка переменных окружения
```bash
# В терминале проекта
echo $NEXT_PUBLIC_AI_API_KEY
```

Или создайте тестовый endpoint:
```typescript
// app/api/test-env/route.ts
export async function GET() {
  return Response.json({
    hasApiKey: !!process.env.NEXT_PUBLIC_AI_API_KEY,
    hasMainPage: !!process.env.NEXT_PUBLIC_MAIN_PAGE,
  });
}
```

## Частые проблемы и решения

### Проблема: API route не работает в production

**Решение**: 
- Убедитесь, что файл находится в `app/api/chat/route.ts`
- Проверьте, что файл экспортирует `POST` функцию
- Проверьте логи деплоя

### Проблема: Медленные ответы

**Решение**: 
- OpenRouter может быть медленным
- Рассмотрите кеширование ответов
- Добавьте таймаут на клиенте

### Проблема: Ответы не на украинском

**Решение**: 
- Проверьте SYSTEM_PROMPT в `chat.ts`
- Убедитесь, что промпт содержит инструкцию отвечать украинским

### Проблема: Ответы слишком длинные

**Решение**: 
- Проверьте `max_tokens: 300` в запросе к OpenRouter
- Убедитесь, что SYSTEM_PROMPT содержит ограничение на 250 символов

## Отладка компонента

Добавьте логирование в компонент:

```typescript
const handleSendMessage = async () => {
  console.log("Sending message:", inputValue);
  // ... остальной код
  try {
    // ...
    console.log("Response received:", response);
  } catch (error) {
    console.error("Error:", error);
  }
};
```

## Проверка работоспособности

Минимальный тест:
1. Откройте страницу с ChatBot
2. Кликните на кнопку чата
3. Введите "тест"
4. Отправьте сообщение
5. Проверьте ответ

Если не работает:
- Проверьте консоль браузера
- Проверьте Network tab
- Проверьте логи сервера
- Проверьте переменные окружения
